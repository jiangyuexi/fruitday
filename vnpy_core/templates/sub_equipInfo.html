<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta http-equiv="keywords" content="关键字,关键字,关键字"/>
  <meta http-equiv="pragma" content="no-cache"/>
  <meta http-equiv="cache-control" content="no-cache"/>
  <meta http-equiv="expires" content="0"/>
  <meta name="description" content="页面描述不超过150个字符"/>
  <meta name="Author" content="页面作者"/>
  <meta name="renderer" content="webkit"/>
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
  <link rel="shortcut icon" href="../static/images/favicon.ico" type="image/x-icon" >
  <link rel="stylesheet" type="text/css" href="../static/layui/dist/css/layui.css"/>
  <link rel="stylesheet" type="text/css" href="../static/zTree_v3/css/zTreeStyle/zTreeStyle.css"/>
  <link rel="stylesheet" href="../static/stylesheets/gx_main.min.css" />
  <link rel="stylesheet" type="text/css" href="../static/iconfont/iconfont.css">
  <!--[if lt IE 9]>
  <script src="../static/html5shiv/dist/html5shiv.min.js"></script>
  <script src="../static/respond/dest/respond.min.js"></script>
  <![endif]-->
  <script src="../static/jquery/dist/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="../static/layui/dist/layui.js" type="text/javascript" charset="utf-8"></script>
  <script src="../static/zTree_v3/js/jquery.ztree.core.js" type="text/javascript" charset="utf-8"></script>
  <script src="../static/zTree_v3/js/jquery.ztree.excheck.js" type="text/javascript" charset="utf-8"></script>
  <script src="../static/zTree_v3/js/jquery.ztree.exedit.js" type="text/javascript" charset="utf-8"></script>
  <!--mine-->
  <script src="../static/javascripts/gx_main.min.js" type="text/javascript" charset="utf-8"></script>
  	<style type="text/css">
		.ztree li span.button.add {margin-left:2px; margin-right: -1px; background-position:-144px 0; vertical-align:top; *vertical-align:middle}
	</style>
</head>
<body class="frame">
	
	<!--树-->
	<blockquote class="layui-elem-quote">
		<ul id="treeDemo" class="ztree"></ul>
		<div>
			<button class="layui-btn layui-btn-darkBlue" id="addParent">创建节点</button>
			<!--<button class="layui-btn layui-btn-darkBlue" id="addLeaf">创建一个没有子节点的节点</button>-->
			<button class="layui-btn layui-btn-darkBlue" id="edit">编辑名称</button>
			<button class="layui-btn layui-btn-darkBlue" id="remove">删除当前选中的节点</button>
			<button class="layui-btn layui-btn-darkBlue" id="clearChildren">清空当前选中节点的子节点</button>
		</div>
	</blockquote>

	<script type="text/javascript">
		layui.use(['layer','jquery'], function(){
			var layer = layui.layer,$ = layui.jquery;
			var setting = {
				view: {
					selectedMulti: false,
					showIcon: false
				},
				edit: {
					enable: true,
					showRemoveBtn: false,
					showRenameBtn: false
				},
				data: {
					keep: {
						parent:true,
					},
					simpleData: {
						enable: true
					}
				},
				callback: {
					beforeDrag: beforeDrag,
					beforeRemove: beforeRemove,
					beforeRename: beforeRename,
					onRemove: onRemove,
					onRename: changeName
				}
			};
			
			var zNodes = [];
			/*[
				{ id:1001, pId:0, name:"父节点 1", open:true},
				{ id:1001001, pId:1001, name:"叶子节点 1-1",open:true},
				{ id:1002, pId:0, name:"父节点 2", open:true},
				{ id:1002001, pId:1002, name:"叶子节点 2-1",open:true},
				{ id:1002002, pId:1002, name:"叶子节点 2-2",open:true},
				{ id:1002003, pId:1002, name:"叶子节点 2-3",open:true},
				{ id:1003, pId:0, name:"父节点 3", open:true},
				{ id:1003001, pId:1003, name:"叶子节点 3-1"},
				{ id:1003002, pId:1003, name:"叶子节点 3-2"},
				{ id:1001002, pId:1001, name:"叶子节点 1-2"},
				{ id:1001003, pId:1001, name:"叶子节点 1-3"},
				{ id:1003003, pId:1003, name:"叶子节点 3-3"}
			];*/
			$.ajax({
			  url:"/cgi-bin/Qt_Cgic.cgi",
			  type:"get",
			  data:{FileName:"sub_equipInfo.html",method:"construct_tree"},
			  async:false,
			  timeout:3000,
			  success:function(data){
				var data = eval(data);
				if(data){
					zNodes = data;
				}
			  },
			  error:function(e){
			     layer.alert(e);
			  }
			});
			
			var log, className = "dark";
			function beforeDrag(treeId, treeNodes) {
				return false;
			}
			function beforeRemove(treeId, treeNode) {
				className = (className === "dark" ? "":"dark");
				showLog("[ "+getTime()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
				return confirm("确认删除 节点 -- " + treeNode.name + " 吗？");
			}
			function onRemove(e, treeId, treeNode) {
				showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
			}
			function beforeRename(treeId, treeNode, newName) {
				if (newName.length == 0) {
					layer.msg("节点名称不能为空。");
					var zTree = $.fn.zTree.getZTreeObj("treeDemo");
					setTimeout(function(){zTree.editName(treeNode)}, 10);
					return false;
				}
				return true;
			}
			function showLog(str) {
				if (!log) log = $("#log");
				log.append("<li class='"+className+"'>"+str+"</li>");
				if(log.children("li").length > 8) {
					log.get(0).removeChild(log.children("li")[0]);
				}
			}
			function getTime() {
				var now= new Date(),
				h=now.getHours(),
				m=now.getMinutes(),
				s=now.getSeconds(),
				ms=now.getMilliseconds();
				return (h+":"+m+":"+s+ " " +ms);
			}
			function add(e) {
				var now= new Date(),
					h=now.getHours(),
					m=now.getMinutes(),
					s=now.getSeconds(),
					ms=now.getMilliseconds(),
					newCount = h+""+m+""+s+""+ms;
				var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
				nodes = zTree.getSelectedNodes(),
				treeNode = nodes[0];				
				if (treeNode) {
					treeNode = zTree.addNodes(treeNode, {id:(newCount), pId:treeNode.id, isParent:false, name:"新建子节点,点击编辑名称按钮,重命名"});
				} else {
					treeNode = zTree.addNodes(null, {id:(newCount), pId:0, isParent:true, name:"新建节点,点击编辑名称按钮,重命名"});
				}
				if (treeNode) {
					treeNode[0].FileName = "sub_equipInfo.html";
					treeNode[0].method = "create_node";
					$.ajax({
						url:"/cgi-bin/Qt_Cgic.cgi",
						type:"get",
						data:treeNode[0],
						async:true,
						timeout:3000,
						success:function(data){
							var data = eval("["+data+"]");
							if(data[0].return == "success"){
								layer.msg('添加节点成功');
								console.log(treeNode[0]);
								//zTree.editName(treeNode[0]);//创建节点后，禁止编辑
							}else if(data[0].return == "error"){
								layer.alert('添加节点失败(已存在同名节点)');
								zTree.removeNode(treeNode[0]);
							}else{
								layer.alert('服务器解析失败');
							}
						},
						error:function(e){
							layer.alert(e);
						}
					});
					
				}				
			};
			function edit() {
				var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
				nodes = zTree.getSelectedNodes(),
				treeNode = nodes[0];
				if (nodes.length == 0) {
					alert("请先选择一个节点");
					return;
				}else{
					zTree.editName(treeNode);
				}
				
			};
			function remove(e) {
				var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
				nodes = zTree.getSelectedNodes(),
				treeNode = nodes[0];
				if (nodes.length == 0) {
					alert("请先选择一个节点");
					return;
				}
				treeNode.FileName = "sub_equipInfo.html";
				treeNode.method = "delete_node";
				$.ajax({
					url:"/cgi-bin/Qt_Cgic.cgi",
					type:"get",
					data:treeNode,
					//async:false,
					async:true,
					timeout:3000,
					success:function(data){
						var data = eval("["+data+"]");
						if(data[0].return == "success"){
							layer.msg('删除当前节点成功');
							zTree.removeNode(treeNode);
						}else if(data[0].return == "error"){
							layer.alert('删除当前节点失败');
						}else{
							layer.alert('服务器解析失败');
						}
					},
					error:function(e){
						layer.alert(e);
					}
				});
			};
			function clearChildren(e) {
				var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
				nodes = zTree.getSelectedNodes();
				treeNode = nodes[0];
				if (nodes.length == 0 || !nodes[0].isParent) {
					layer.alert("请先选择一个父节点");
					return;
				}else{
					treeNode.FileName = "sub_equipInfo.html";
					treeNode.method = "delete_all_child_node";
					$.ajax({
						url:"/cgi-bin/Qt_Cgic.cgi",
						type:"get",
						data:treeNode,
						//async:false,
						async:true,
						timeout:3000,
						success:function(data){
							var data = eval("["+data+"]");
							if(data[0].return == "success"){
								layer.msg('删除当前节点成功');
								zTree.removeChildNodes(treeNode);
							}else if(data[0].return == "error"){
								layer.alert('删除当前节点失败');
							}else if(data[0].return == ""){
								return;
							}else{
								layer.alert('服务器解析失败');
							}
						},
						error:function(e){
							layer.alert(e);
						}
					});
				};
				zTree.removeChildNodes(treeNode);
			};
			function changeName(method){
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				var nodes = zTree.getSelectedNodes();
				treeNode = nodes[0];
				treeNode.FileName="sub_equipInfo.html";
				treeNode.method="update";
				console.log(treeNode);
				$.ajax({
			  		url:"/cgi-bin/Qt_Cgic.cgi",
			  		type:"get",
			  		data:treeNode,
					async:true,
					timeout:3000,
			  		success:function(data){
						var data = eval("["+data+"]");
						console.log(data[0].return);
						if(data[0].return == "success"){
							layer.msg('操作成功');
						}else if(data[0].return == "error"){
							layer.alert('编辑节点失败');
							if (nodes.length>0) {
								zTree.updateNode(nodes[0]);
							}
						}else{
							layer.alert('服务器解析失败');
						}
			  		},
			  		error:function(e){
			     		layer.alert(e);
			  		}
				});
			}
			$(document).ready(function(){
				//初始化树、操作以及提交给后台
				$.fn.zTree.init($("#treeDemo"), setting, zNodes);
				$("#addParent").bind("click", {isParent:true}, add);
				$("#edit").bind("click", edit);
				$("#remove").bind("click", remove);
				$("#clearChildren").bind("click", clearChildren);
			});
		});
	</script>
</body>
</html>
