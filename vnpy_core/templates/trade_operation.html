<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
    <meta content="关键字,关键字,关键字" http-equiv="keywords"/>
    <meta content="no-cache" http-equiv="pragma"/>
    <meta content="no-cache" http-equiv="cache-control"/>
    <meta content="0" http-equiv="expires"/>
    <meta content="页面描述不超过150个字符" name="description"/>
    <meta content="页面作者" name="Author"/>
    <meta content="webkit" name="renderer"/>
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport"/>
    <link href="../static/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="../static/layui/css/layui.css" rel="stylesheet" type="text/css"/>
    <link href="../static/stylesheets/gx_main.min.css" rel="stylesheet"/>
    <link href="../static/iconfont/iconfont.css" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
    <script src="../static/html5shiv/dist/html5shiv.min.js"></script>
    <script src="../static/respond/dest/respond.min.js"></script>
    <![endif]-->
    <script charset="utf-8" src="../static/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script charset="utf-8" src="../static/layui/layui.js" type="text/javascript"></script>
    <script src="../static/highcharts-5.0.14/code/highcharts.js" type="text/javascript"></script>
    <!--mine-->
    <script charset="utf-8" src="../static/javascripts/gx_main.min.js" type="text/javascript"></script>
</head>
<body class="gx_index">
<form class="layui-form trade_operation" id="form_trade_operation">
    <input name="FileName" type="hidden" value="trade_operation.html"/>
    <input name="method" type="hidden" value="send_post"/>
    <div class="layui-form-item">
        <!-- 选择交易品种 -->
        <div class="layui-inline">
            <label class="layui-form-label">交易品种:</label>
            <div class="layui-input-inline">
                <select class="layui-form-select" lay-search lay-skin="primary">
                    <option value="XBTUSD">XBTUSD</option>
                </select>
            </div>
        </div>
        <!-- 选择交易所 -->
        <div class="layui-inline">
            <label class="layui-form-label">交易所:</label>
            <div class="layui-input-inline">
                <select class="layui-form-select" lay-search lay-skin="primary">
                    <option value="BITMAX">BITMAX</option>
                </select>
            </div>
        </div>
        <!-- 数据区间 -->
        <div class="layui-inline">
            <label class="layui-form-label">杠杆:</label>
            <div class="layui-input-inline" style="width: 400px;">
                <div class="" id="data-section"></div>
                <div class="data-section-show-num"></div>
            </div>
        </div>
        <div class="layui-inline">
            <button class="layui-btn layui-btn-darkBlue">显示</button>
        </div>
    </div>

    <!-- 用户信息start -->
    <div class="layui-col-md12">
        <table class="layui-table" id="user-table-1" lay-even lay-filter="user-table-1" lay-skin="line">
            <!--<thead>
            <tr>
                <th>备注名</th>
                <th>仓位和方向</th>
                <th>开仓价格</th>
                <th>表记价格</th>
                <th>账户用资金</th>
                <th>冻结资金</th>
                <th>总资金</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>123</td>
                <td>123</td>
                <td>123</td>
                <td>123</td>
                <td>123</td>
                <td>123</td>
                <td>123</td>
            </tr>
            </tbody>-->
        </table>
    </div>
    <!-- 用户信息end -->

    <!--【发送】协议配置-->
    <table class="layui-table">
        <thead class="lightBlue center">
        <tr>
            <th colspan="12">成功接入的账户</th>
        </tr>
        </thead>
        <tbody class="grey center">
        <!-- <tr>
            <textarea class="layui-textarea" id="return_account_login_info" style="width:90%;height:20px" readonly></textarea>
        </tr> -->
        <tr>
            <td>账号名称</td>
            <td>
                <select id="sub_config_user_ids" lay-filter="sub_config_user_ids" lay-verify="required"
                        name="parameter_user_ids"></select>
            </td>
            <td>当前价格</td>
            <td colspan="9"><input class="layui-input" id="price" lay-verify="required" readonly type="text"></td>
        </tr>
        <tr>
            <input class="layui-input" colspan="6" id="position" lay-verify="required" readonly type="text">
        </tr>
        <tr>账户余额</tr>

        <tr>
            <textarea class="layui-textarea" id="balance_json" readonly style="height:20px"></textarea>
        </tr>

        <tr>
            <td>市价/限价</td>
            <td>
                <select id="open_position_market_limit" lay-verify="required">
                    <option value="market">市价</option>
                    <option value="limit">限价</option>
                </select>
            </td>
            <td>百分比</td>
            <td>
                <select id="open_position_percent" lay-verify="required">
                    <option value="0">0</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="30">30</option>
                    <option value="35">35</option>
                    <option value="40">40</option>
                    <option value="45">45</option>
                    <option value="50">50</option>
                    <option value="55">55</option>
                    <option value="60">60</option>
                    <option value="65">65</option>
                    <option value="70">70</option>
                    <option value="75">75</option>
                    <option value="80">80</option>
                    <option value="85">85</option>
                    <option value="90">90</option>
                    <option value="95">95</option>
                    <option value="100">100</option>
                </select>
            </td>
            <td>
                价格（USD）
            </td>
            <td>
                <input class="layui-input" id="open_position_price" lay-verify="required" type="text">
            </td>
            <td>
                <select id="open_position_side" lay-verify="required">
                    <option value="buy">做多/购买</option>
                    <option value="sell">做空/卖出</option>
                </select>
            </td>
            <td>
                <button class="layui-btn layui-btn-primary layui-btn-radius" id="open_position_button" type="button">
                    建仓
                </button>
            </td>
        </tr>
        <tr>
            <td>市价/限价</td>
            <td>
                <select id="close_position_market_limit" lay-verify="required">
                    <option value="market">市价</option>
                    <option value="limit">限价</option>
                </select>
            </td>
            <td>百分比</td>
            <td>
                <select id="close_position_percent" lay-verify="required">
                    <option value="0">0</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="30">30</option>
                    <option value="35">35</option>
                    <option value="40">40</option>
                    <option value="45">45</option>
                    <option value="50">50</option>
                    <option value="55">55</option>
                    <option value="60">60</option>
                    <option value="65">65</option>
                    <option value="70">70</option>
                    <option value="75">75</option>
                    <option value="80">80</option>
                    <option value="85">85</option>
                    <option value="90">90</option>
                    <option value="95">95</option>
                    <option value="100">100</option>
                </select>
            </td>
            <td>
                价格（USD）
            </td>
            <td>
                <input class="layui-input" id="close_position_price" lay-verify="required" type="text">
            </td>

            <td>
                <button class="layui-btn layui-btn-primary layui-btn-radius layui-btn-danger" id="close_position_button"
                        type="button">平仓
                </button>
            </td>
        </tr>
        <tr>
            <td>止损止盈</td>
            <td>
                <select id="stop_position_market_limit" lay-verify="required">
                    <option value="Stop">市价</option>
                    <option value="StopLimit">限价</option>
                </select>
            </td>
            <td>百分比</td>
            <td>
                <select id="stop_position_percent" lay-verify="required">
                    <option value="0">0</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="30">30</option>
                    <option value="35">35</option>
                    <option value="40">40</option>
                    <option value="45">45</option>
                    <option value="50">50</option>
                    <option value="55">55</option>
                    <option value="60">60</option>
                    <option value="65">65</option>
                    <option value="70">70</option>
                    <option value="75">75</option>
                    <option value="80">80</option>
                    <option value="85">85</option>
                    <option value="90">90</option>
                    <option value="95">95</option>
                    <option value="100">100</option>
                </select>
            </td>
            <td>
                价格（USD）
            </td>
            <td>
                <input class="layui-input" id="stop_position_price" lay-verify="required" type="text">
            </td>
            <td>
                触发价格
            </td>
            <td>
                <input class="layui-input" id="stopPx_position_price" lay-verify="required" type="text">
            </td>
            <td>
                <select id="stop_position_side" lay-verify="required">
                    <option value="Buy">买入</option>
                    <option value="Sell">卖出</option>
                </select>
            </td>
            <td>
                <button class="layui-btn layui-btn-primary layui-btn-radius layui-btn-danger" id="stop_position_button"
                        type="button">设置止损单
                </button>
            </td>
        </tr>
        </tbody>
    </table>
</form>

<script>
    layui.use(['form', 'layedit', 'laydate', 'element', 'jquery', 'slider', 'table'], function () {
        var form = layui.form,
            layer = layui.layer,
            layedit = layui.layedit,
            laydate = layui.laydate,
            element = layui.element,
            $ = layui.jquery,
            table = layui.table,
            slider = layui.slider;

        /**
         *  字符串转换成 json 对象
         **/
        function strToJson(str) {
            var json = eval('(' + str + ')');
            return json;
        }
        /**
         * 获取cookie 通过 key
         * @param name  key
         * @returns {null} value
         */
        function getCookie(name) {
            var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");

            if (arr = document.cookie.match(reg))

                return unescape(arr[2]);
            else
                return null;
        }
        /**
         * 设置 cookie
         * @param name    key
         * @param value  value
         * @param time  时间
         */
        function setCookie(name, value, time) {
            var strsec = getsec(time);
            var exp = new Date();
            exp.setTime(exp.getTime() + strsec * 1);
            document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString();
        }
        // 最简单数组去重法
        /*
         * 新建一新数组，遍历传入数组，值不在新数组就push进该新数组中
         * IE8以下不支持数组的indexOf方法
         * */
        function uniq(array) {
            var temp = []; //一个新的临时数组
            for (var i = 0; i < array.length; i++) {
                if (temp.indexOf(array[i]) == -1) {
                    temp.push(array[i]);
                }
            }
            return temp;
        }

        // 从cookies获取到用户ids,初始化用户基本信息表
        function init_user_info_table() {
            var cookieObj = getCookie("user_ids");
            //把\054转换成对应的','
            cookieObj = cookieObj.replace(/\\054/g, ",");
            cookieObj = cookieObj.replace(/"/g, "");
            $("#return_account_login_info").val("<pre>" + cookieObj + "</pre>");
            var obj_user_ids = strToJson(cookieObj);
            //debugger;
            //填充数据到用户名称下拉框
            var tableUserData = [];

            for (var i = 0; i < obj_user_ids.length; i++) {
                tableUserData[i] = {
                    'test1': obj_user_ids[i],
                    'test2': '',
                    'test3': '',
                    'test4': '',
                    'test5': '',
                    'test6': '',
                    'test7': '',
                    'test8': ''
                }
            }

            return tableUserData;
        }

        // 从cookies获取到用户ids
        function getUserIds() {
            var cookieObj = getCookie("user_ids");
            var options_user_ids = [];
            //把\054转换成对应的','
            cookieObj = cookieObj.replace(/\\054/g, ",");
            cookieObj = cookieObj.replace(/"/g, "");
            $("#return_account_login_info").val("<pre>" + cookieObj + "</pre>");
            var obj_user_ids = strToJson(cookieObj);
            //debugger;
            //填充数据到用户名称下拉框
            for (var i = 0; i < obj_user_ids.length; i++) {

                options_user_ids += '<option value="' + i + '">' + obj_user_ids[i] + '</option>';
            }
            $("#sub_config_user_ids").find("option").remove();
            $("#sub_config_user_ids").append(options_user_ids); //填充数据到用户名称下拉框

            form.render("select");
            console.log(cookieObj);
        }

        function initDataSection(elem, opt) {
            // 初始化参数
            var  maxStep = opt.maxStep || 100
                ,step = opt.step || 10
                ,stepArr  = opt.stepArr || null
                ,stepNum = Math.ceil(maxStep / step)
                ,left = opt.left || '-3%'
                ,initStr = ''
                ,defaultStyle = "position: absolute; color: #fff;";

            if (step > maxStep) return;

            for (var i = 0; i <= stepNum; i++) {
                initStr += '<span style=" ' + defaultStyle + '; left: ' + (i * stepNum) + '%">';
                initStr += (stepArr[i] ? stepArr[i] : (step * i)) + '</span>';
            }

            $(elem).css({
                'position': 'relative',
                'left': left,
                'top': '.5rem'
            });
            $(elem).html(initStr);
        }

        //十五秒刷新一次
        window.get_price = function () {
            var user = {};
            user.exchange = "BITMEX";
            user.gateway_name = "BITMEX";
            user.user_id = $("#sub_config_user_ids option:selected").text(); //获取文本
            user.symbol = "BTC/USD";
            //debugger;
            $.ajax({
                url: "fetch_ticks/",
                type: "post",
                data: JSON.stringify(user),
                async: true,
                success: function (res) {
                    var __data = unescape(res.replace(/\\u/g, '%u'));
                    var obj = strToJson(__data);
                    $("#price").val(obj.ticks.last);
                },
                error: function (res) {
                    layer.msg("连接服务器失败");
                }
            });
            return false;

        };
        window.get_position = function () {
            var user = {};
            user.exchange = "BITMEX";
            user.gateway_name = "BITMEX";
            user.user_id = $("#sub_config_user_ids option:selected").text(); //获取文本
            user.symbol = "BTC/USD";
            //debugger;
            $.ajax({
                url: "fetch_my_trades/",
                type: "post",
                data: JSON.stringify(user),
                async: true,
                success: function (res) {
                    var __data = unescape(res.replace(/\\u/g, '%u'));
                    var obj = strToJson(__data);
                    $("#position").val("仓位和方向：" + JSON.stringify(obj.position.currentQty) +
                        "开仓价格：" + JSON.stringify(obj.position.avgEntryPrice) + "标记价格mark:" +
                        JSON.stringify(obj.position.markPrice));
                },
                error: function (res) {
                    layer.msg("连接服务器失败");
                }
            });
            return false;


        };

        //setInterval('get_price()', 2000);
        //setInterval('get_position()', 3000);

        $(function () {
            getUserIds();
            var opt = {
                'stepArr': ['全仓']
            }
            initDataSection('.data-section-show-num', opt);
        });

        // 杠杆选择滑块
        slider.render({
            elem: '#data-section'
            , step: 10 				// 步长
            , showstep: true			// 开启间隔点
            , tips: true
            , change: function (e) {
                console.log(e);
            }
        });

        // 用户信息表
        table.render({
            elem: '#user-table-1'
            , cellMinWidth: 80
            , title: '哈哈'
            // ,toolbar: 'default'
            , cols: [[
                {field: 'test1', title: '备注名'}
                , {field: 'test2', title: '仓位和方向'}
                , {field: 'test3', title: '开仓价格'}
                , {field: 'test4', title: '标记价格'}
                , {field: 'test5', title: '爆仓价格'}
                , {field: 'test6', title: '账户可用资金'}
                , {field: 'test7', title: '冻结资金'}
                , {field: 'test8', title: '总资金'}
                , {field: 'test9', title: '操作', toolbar: '#rowDefaultToolCodeStr'}
            ]]
            , data: init_user_info_table()
        });
        // 用户信息表操作监听
        table.on('tool(user-table-1)', function (data) {
            var event = data.event, rows = data.tr;
        });

        //选择账户
        form.on('select(sub_config_user_ids)', function (data) {

            var user = {};
            user.exchange = "BITMEX";
            user.gateway_name = "BITMEX";
            user.name = data.elem.name;
            user.user_id = $("#sub_config_user_ids option:selected").text(); //获取文本
            //debugger;
            $.ajax({
                url: "balance/",
                type: "post",
                data: JSON.stringify(user),
                async: true,
                success: function (res) {
                    var __data = unescape(res.replace(/\\u/g, '%u'));
                    var obj = strToJson(__data);

                    var balances_text = "";
                    for (var i = 0; i < obj.balances.length; i++) {
                        var o = obj.balances[i];
                        balances_text += JSON.stringify(o.BTC) + "\n\r" +
                            "free: " + JSON.stringify(o.free) + "\n\r" +
                            "used: " + JSON.stringify(o.used) + "\n\r" +
                            "total:" + JSON.stringify(o.total) + "\n\r";

                    }

                    $("#balance_json").val(balances_text);
                },
                error: function (res) {
                    layer.msg("连接服务器失败");
                }
            });
            return false;
        });
        //开仓按钮被点击
        $(document).on('click', '#open_position_button', function () {
            //准备数据
            var user = {};
            user.exchange = "BITMEX";
            user.gateway_name = "BITMEX";
            //"账户":"jiangyuexi1992@qq.com",
            var params = {};
            params.symbol = "BTC/USD";
            //市价/限价
            var type = $("#open_position_market_limit option:selected").val();
            params.type = type;
            //buy/sell
            var side = $("#open_position_side option:selected").val();
            params.side = side;
            params.percent = $("#open_position_percent option:selected").val();
            //数量
            //params.amount=20.0;
            //开仓价格
            var price = $("#open_position_price").val();
            params.price = price;
            //
            //当前价格
            var current_price = $("#price").val();
            params.current_price = current_price;
            user.params = params;
            //console.log(user);
            //debugger;
            $.ajax({
                url: "create_orders/",
                type: "post",
                data: JSON.stringify(user),
                async: true,
                success: function (res) {
                    var __data = unescape(res.replace(/\\u/g, '%u'));
                    var obj = strToJson(__data);

                    var balances_text = "";

                    layer.msg(obj.msg);
                },
                error: function (res) {
                    layer.msg("连接服务器失败");
                }
            });
            return false;

        });
        //平仓按钮点击
        $(document).on('click', '#close_position_button', function () {
            //准备数据
            var user = {};
            user.exchange = "BITMEX";
            user.gateway_name = "BITMEX";
            //"账户":"jiangyuexi1992@qq.com",
            var params = {};
            params.symbol = "BTC/USD";
            //市价/限价
            var type = $("#close_position_market_limit option:selected").val();
            params.type = type;
            //buy/sell
            var side = $("#close_position_side option:selected").val();
            params.side = side;
            params.percent = $("#close_position_percent option:selected").val();
            //数量
            //params.amount=20.0;
            params.price = $("#close_position_price").val();
            //当前价格
            var current_price = $("#price").val();
            params.current_price = current_price;
            user.params = params;
            //console.log(user);
            //debugger;
            $.ajax({
                url: "create_orders_close/",
                type: "post",
                data: JSON.stringify(user),
                async: true,
                success: function (res) {
                    var __data = unescape(res.replace(/\\u/g, '%u'));
                    var obj = strToJson(__data);
                    var balances_text = "";

                    //debugger;
                    layer.msg(obj.msg);
                },
                error: function (res) {
                    layer.msg("连接服务器失败");
                }
            });
            return false;

        });

        //设置止损止盈
        $(document).on('click', '#stop_position_button', function () {
            //准备数据
            var user = {};
            user.exchange = "BITMEX";
            user.gateway_name = "BITMEX";
            //"账户":"jiangyuexi1992@qq.com",
            var params = {};
            params.symbol = "BTC/USD";
            //市价/限价
            var type = $("#stop_position_market_limit option:selected").val();
            params.type = type;
            //buy/sell
            var side = $("#stop_position_side option:selected").val();
            params.side = side;
            params.percent = $("#stop_position_percent option:selected").val();
            //数量
            //params.amount=20.0;
            params.price = $("#stop_position_price").val();
            //触发价格
            var stopPx = $("#stopPx_position_price").val();
            params.stopPx = stopPx;
            //当前价格
            var current_price = $("#price").val();
            params.current_price = current_price;
            user.params = params;
            //console.log(user);
            //debugger;
            $.ajax({
                url: "set_stop/",
                type: "post",
                data: JSON.stringify(user),
                async: true,
                success: function (res) {
                    var __data = unescape(res.replace(/\\u/g, '%u'));
                    var obj = strToJson(__data);
                    var balances_text = "";

                    //debugger;
                    layer.msg(obj.msg);
                },
                error: function (res) {
                    layer.msg("连接服务器失败");
                }
            });
            return false;
        });
    });
</script>

<!-- 工具栏模板：-->
<script id="rowDefaultToolCodeStr" type="text/html">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" type="button" lay-event="add">添加</button>
        <button class="layui-btn layui-btn-sm" type="button" lay-event="delete">删除</button>
        <button class="layui-btn layui-btn-sm" type="button" lay-event="update">编辑</button>
    </div>
</script>
</body>
</html>
